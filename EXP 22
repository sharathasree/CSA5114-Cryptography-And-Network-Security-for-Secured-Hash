#include <stdio.h>
#include <stdint.h>

uint8_t IP(uint8_t b){
    return ((b>>1)&1)<<7 | ((b>>5)&1)<<6 | ((b>>2)&1)<<5 | ((b>>0)&1)<<4 |
           ((b>>3)&1)<<3 | ((b>>7)&1)<<2 | ((b>>4)&1)<<1 | ((b>>6)&1)<<0;
}

uint8_t IP_inv(uint8_t b){
    return ((b>>7)&1)<<1 | ((b>>6)&1)<<5 | ((b>>5)&1)<<2 | ((b>>4)&1)<<0 |
           ((b>>3)&1)<<3 | ((b>>2)&1)<<7 | ((b>>1)&1)<<4 | ((b>>0)&1)<<6;
}

uint16_t P10(uint16_t k){
    return ((k>>1)&1)<<9 | ((k>>0)&1)<<8 | ((k>>8)&1)<<7 | ((k>>7)&1)<<6 | ((k>>5)&1)<<5 |
           ((k>>2)&1)<<4 | ((k>>9)&1)<<3 | ((k>>6)&1)<<2 | ((k>>4)&1)<<1 | ((k>>3)&1)<<0;
}

uint8_t P8(uint16_t k){
    return ((k>>5)&1)<<7 | ((k>>2)&1)<<6 | ((k>>6)&1)<<5 | ((k>>3)&1)<<4 |
           ((k>>7)&1)<<3 | ((k>>4)&1)<<2 | ((k>>9)&1)<<1 | ((k>>8)&1)<<0;
}

uint16_t LS1(uint16_t k){
    uint8_t l = (k>>5)&0x1F, r = k&0x1F;
    return ((l<<1)| (l>>4 &1))<<5 | ((r<<1)|(r>>4 &1));
}

uint16_t LS2(uint16_t k){
    uint8_t l = (k>>5)&0x1F, r = k&0x1F;
    return ((l<<2)| (l>>3 &3))<<5 | ((r<<2)|(r>>3 &3));
}

uint8_t EP(uint8_t b){
    return ((b>>0)&1)<<7 | ((b>>3)&1)<<6 | ((b>>2)&1)<<5 | ((b>>1)&1)<<4 |
           ((b>>2)&1)<<3 | ((b>>1)&1)<<2 | ((b>>0)&1)<<1 | ((b>>3)&1)<<0;
}

uint8_t P4(uint8_t b){
    return ((b>>1)&1)<<3 | ((b>>3)&1)<<2 | ((b>>2)&1)<<1 | ((b>>0)&1)<<0;
}

uint8_t F(uint8_t r, uint8_t sk){
    uint8_t e = EP(r);
    uint8_t x = e ^ sk;
    uint8_t l = (x>>4)&0xF, rr = x&0xF;

    uint8_t S0[4][4]={{1,0,3,2},{3,2,1,0},{0,2,1,3},{3,1,3,2}};
    uint8_t S1[4][4]={{0,1,2,3},{2,0,1,3},{3,0,1,0},{2,1,0,3}};

    uint8_t r0 = S0[((l&8)>>2)| (l&1)][(l>>1)&3];
    uint8_t r1 = S1[((rr&8)>>2)|(rr&1)][(rr>>1)&3];

    return P4((r0<<2)|r1);
}

uint8_t S_DES(uint8_t block, uint8_t k1, uint8_t k2){
    uint8_t b = IP(block);
    uint8_t l = b>>4, r = b&0xF;

    uint8_t t = l ^ F(r,k1);
    l = r; 
    r = t ^ F(l,k2);

    return IP_inv((l<<4)|r);
}

void gen_keys(uint16_t key, uint8_t *k1, uint8_t *k2){
    uint16_t p = P10(key);
    uint16_t ls1 = LS1(p);
    *k1 = P8(ls1);
    uint16_t ls2 = LS2(ls1);
    *k2 = P8(ls2);
}

void cbc_encrypt(uint8_t *out, uint8_t *in, int blocks, uint8_t iv, uint8_t k1, uint8_t k2){
    uint8_t prev = iv;
    for(int i=0;i<blocks;i++){
        uint8_t x = in[i] ^ prev;
        out[i] = S_DES(x, k1, k2);
        prev = out[i];
    }
}

void cbc_decrypt(uint8_t *out, uint8_t *in, int blocks, uint8_t iv, uint8_t k1, uint8_t k2){
    uint8_t prev = iv;
    for(int i=0;i<blocks;i++){
        uint8_t d = S_DES(in[i], k2, k1);
        out[i] = d ^ prev;
        prev = in[i];
    }
}

uint8_t str2byte(const char*s){
    uint8_t v=0;
    for(int i=0;i<8;i++) v = (v<<1) | (s[i]-'0');
    return v;
}

int main(){
    uint8_t iv   = str2byte("10101010");
    uint8_t key10= 0b0111111101;

    uint8_t pt[2] = {
        str2byte("00000001"),
        str2byte("00100011")
    };

    uint8_t k1,k2;
    gen_keys(key10,&k1,&k2);

    uint8_t ct[2];
    cbc_encrypt(ct, pt, 2, iv, k1, k2);

    printf("Ciphertext:\n");
    for(int i=0;i<2;i++)
        for(int b=7;b>=0;b--)
            printf("%d", (ct[i]>>b)&1);
    printf("\n");

    uint8_t dec[2];
    cbc_decrypt(dec, ct, 2, iv, k1, k2);

    printf("Decrypted:\n");
    for(int i=0;i<2;i++)
        for(int b=7;b>=0;b--)
            printf("%d", (dec[i]>>b)&1);
    printf("\n");

    return 0;
}
