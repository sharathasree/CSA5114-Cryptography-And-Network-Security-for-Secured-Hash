#include <stdio.h>
#include <stdint.h>

int P10[10] = {3,5,2,7,4,10,1,9,8,6};
int P8[8]  = {6,3,7,4,8,5,10,9};
int P4[4]  = {2,4,3,1};
int IP[8]  = {2,6,3,1,4,8,5,7};
int IPinv[8] = {4,1,3,5,7,2,8,6};
int EP[8]  = {4,1,2,3,2,3,4,1};

int S0[4][4] = {
    {1,0,3,2},
    {3,2,1,0},
    {0,2,1,3},
    {3,1,3,2}
};
int S1[4][4] = {
    {0,1,2,3},
    {2,0,1,3},
    {3,0,1,0},
    {2,1,0,3}
};
int bit(uint16_t x, int p) { return (x >> (p-1)) & 1; }
uint16_t setbit(uint16_t x, int p, int v) { return v ? (x | (1 << (p-1))) : (x & ~(1 << (p-1))); }

uint16_t perm(uint16_t in, int *p, int n) {
    uint16_t out = 0;
    for(int i=0;i<n;i++)
        out = setbit(out, n-i, bit(in, p[i]));
    return out;
}
uint16_t ls(uint16_t x, int n) {
    return ((x << n) | (x >> (5-n))) & 0x1F;
}

void genkeys(uint16_t key, uint8_t *K1, uint8_t *K2) {
    key = perm(key, P10, 10);
    uint16_t L = (key >> 5) & 0x1F;
    uint16_t R = key & 0x1F;

    L = ls(L,1); R = ls(R,1);
    *K1 = perm((L<<5)|R, P8, 8);

    L = ls(L,2); R = ls(R,2);
    *K2 = perm((L<<5)|R, P8, 8);
}
uint8_t f(uint8_t r, uint8_t K) {
    uint8_t e = perm(r, EP, 8);
    uint8_t x = e ^ K;

    int row0 = (bit(x,8)<<1)|bit(x,1);
    int col0 = (bit(x,7)<<1)|bit(x,6);
    int row1 = (bit(x,4)<<1)|bit(x,5);
    int col1 = (bit(x,3)<<1)|bit(x,2);

    int s0 = S0[row0][col0];
    int s1 = S1[row1][col1];

    uint8_t out = (s0<<2)|s1;
    return perm(out, P4, 4);
}

uint8_t sdes(uint8_t pt, uint8_t K1, uint8_t K2, int mode) {
    uint16_t x = perm(pt, IP, 8);
    uint8_t L = (x >> 4) & 0x0F, R = x & 0x0F;

    uint8_t kA = mode==0 ? K1 : K2;
    uint8_t kB = mode==0 ? K2 : K1;

    uint8_t t = L ^ f(R, kA);
    L = R;
    R = t;

    uint16_t y = (L<<4)|R;
    y = perm(y, IPinv, 8);
    return y;
}

int main() {
    uint16_t key = 0b0111111101;
    uint8_t K1, K2;
    genkeys(key, &K1, &K2);

    uint8_t plaintext[3] = {0x01, 0x02, 0x04};
    uint8_t ciphertext[3], decrypted[3];

    uint8_t counter = 0x00;

    for(int i=0;i<3;i++){
        uint8_t keystream = sdes(counter, K1, K2, 0);
        ciphertext[i] = plaintext[i] ^ keystream;
        counter++;
    }

    counter = 0x00;

    for(int i=0;i<3;i++){
        uint8_t keystream = sdes(counter, K1, K2, 0);
        decrypted[i] = ciphertext[i] ^ keystream;
        counter++;
    }

    printf("Ciphertext:\n");
    for(int i=0;i<3;i++) printf("%02X ", ciphertext[i]);

    printf("\nDecrypted:\n");
    for(int i=0;i<3;i++) printf("%02X ", decrypted[i]);

    return 0;
}
